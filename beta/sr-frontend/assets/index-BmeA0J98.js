import{X as _e,r as c,W as L,aj as Le,n as N,q as l,p as e,a$ as je,T,B as f,a4 as he,U as Q,M as Z,b0 as Y,aD as ee,b1 as ze,av as pe,w as ve,b2 as Fe,a6 as Ne,ak as He,al as X,am as We,an as xe,ao as Ge,ap as Ue,a7 as $e,aq as Ve,ar as Xe,as as Je,at as Qe,aA as P,z as b,R as ge,I as ne,ay as Ze,a9 as le,x as Ye,aE as et,aF as A,y,A as ke,a2 as fe,aH as te,ab as ye,b3 as ce,b4 as we,ad as Ie,b5 as Re,J as De,b6 as de,a3 as Ee,b7 as tt,$ as be,aG as nt,aI as st,aZ as it,aQ as ot,aR as Se,aS as rt,aV as at}from"./index-okgin5UC.js";import{P as lt,T as Me,a as ct,N as dt,I as ut,t as ht,Q as pt,e as gt,E as Te,f as ft,U as $,g as mt,o as Ct,S as xt,W as yt,h as bt,i as St,j as Lt,A as vt,B as kt,O as wt,F as It,C as Rt,H as Dt,J as Et,K as Mt,M as Tt}from"./Checkroom-CCkk23gu.js";import{a as O,C as Kt,L as Ot,b as At,D as Bt}from"./UploadCard-BbhSdnB4.js";import{M,D as H,r as Ke,b as Pt,d as qt,C as _t}from"./StatDisplay-CRg8sC3F.js";import{S as E,b as me,c as jt,d as zt,a as Ft,C as Nt,u as Ht}from"./CharacterEditor-COR3RGST.js";import{u as Wt,a as Gt,g as Oe}from"./LightConeTrans-DfmsOd2I.js";import{C as W}from"./CardHeader-9B3qUUV7.js";import{C as w,G as j}from"./Grid-CHgxN6SI.js";import{D as Ut,b as se}from"./BusinessCenter-C65wgsD5.js";import{u as Ce}from"./useBoolState-D5j11McU.js";import{a as Ae,R as _,b as $t}from"./RelicSetAutocomplete-DNSiBQuj.js";import{C as Vt}from"./CardActionArea-Btexhl4n.js";import"./InfoTooltip-9W_69p0p.js";function ue(n){const[t,s]=_e();return c.useEffect(()=>n.followAny((i,r)=>r==="update"&&s()),[n,s]),t}function G(n){const{database:t}=L();return Le(t.charOpts,n)}function Xt({maxBuildsToShow:n,optConfigId:t}){const{database:s}=L(),{t:i}=N("page_optimize");return l(H,{title:i("build",{count:n}),children:[e(M,{children:e(T,{variant:"caption",color:"info.main",children:i("buildDropdownDesc")})}),je.map(r=>e(M,{onClick:()=>s.optConfigs.set(t,{maxBuildsToShow:r}),children:i("build",{count:r})},r))]})}function Jt({levelLow:n,levelHigh:t,setLow:s,setHigh:i,setBoth:r,dark:o=!1,disabled:a=!1,showLevelText:h=!1}){const{t:p}=N("lightcone"),[d,u]=c.useState(n),[S,g]=c.useState(t),x=c.useCallback((m,C)=>{if(typeof C=="number")throw new TypeError;const[R,k]=C;u(R),g(k)},[u,g]);return c.useEffect(()=>u(n),[u,n]),c.useEffect(()=>g(t),[g,t]),l(f,{sx:{width:"100%",display:"flex",alignItems:"center",bgcolor:o?"contentNormal.main":"contentLight.main",overflow:"visible"},children:[l(f,{sx:{width:"max-content",height:32,display:"flex"},children:[h?l(he,{children:[e("span",{style:{padding:"0 1em",width:"max-content",borderRadius:"4px 0 0 4px",display:"flex",justifyContent:"center",alignItems:"center",color:"rgba(255,255,255,0.9)",backgroundColor:"rgb(30,120,200)"},children:p("levelSliderTitle")}),e(O,{orientation:"vertical",flexItem:!0})]}):void 0,e(Z,{value:d,onChange:m=>s(Q(m??0,0,t)),sx:{px:1,width:"3em"},inputProps:{sx:{textAlign:h?"right":"center"}},disabled:a})]}),e(Ae,{sx:{flex:"0 1 100%",mx:2},getAriaLabel:()=>"LightCone Level Range",value:[d,S],onChange:x,onChangeCommitted:(m,C)=>Array.isArray(C)&&r(C[0],C[1]),valueLabelDisplay:"auto",min:0,max:Y,step:1,marks:!0,disabled:a}),e(Z,{value:S,onChange:m=>i(Q(m??0,n,Y)),sx:{px:1,flex:"0 0 3em"},inputProps:{sx:{textAlign:"center"}},disabled:a})]})}function Qt({levelLow:n,levelHigh:t,setLow:s,setHigh:i,setBoth:r,dark:o=!1,disabled:a=!1,showLevelText:h=!1}){const{t:p}=N("artifact"),[d,u]=c.useState(n),[S,g]=c.useState(t),x=c.useCallback((m,C)=>{if(typeof C=="number")throw new TypeError;const[R,k]=C;u(R),g(k)},[u,g]);return c.useEffect(()=>u(n),[u,n]),c.useEffect(()=>g(t),[g,t]),l(f,{sx:{width:"100%",display:"flex",alignItems:"center",bgcolor:o?"contentNormal.main":"contentLight.main",overflow:"visible"},children:[l(f,{sx:{width:"max-content",height:32,display:"flex"},children:[h?l(he,{children:[e("span",{style:{padding:"0 1em",width:"max-content",borderRadius:"4px 0 0 4px",display:"flex",justifyContent:"center",alignItems:"center",color:"rgba(255,255,255,0.9)",backgroundColor:"rgb(30,120,200)"},children:p("levelSliderTitle")}),e(O,{orientation:"vertical",flexItem:!0})]}):void 0,e(Z,{value:d,onChange:m=>s(Q(m??0,0,t)),sx:{px:1,width:"3em"},inputProps:{sx:{textAlign:h?"right":"center"}},disabled:a})]}),e(Ae,{sx:{flex:"0 1 100%",mx:2},getAriaLabel:()=>"Arifact Level Range",value:[d,S],onChange:x,onChangeCommitted:(m,C)=>Array.isArray(C)&&r(C[0],C[1]),valueLabelDisplay:"auto",min:0,max:ee[5],step:1,marks:!0,disabled:a}),e(Z,{value:S,onChange:m=>i(Q(m??0,n,ee[5])),sx:{px:1,flex:"0 0 3em"},inputProps:{sx:{textAlign:"center"}},disabled:a})]})}function Be(n,t=new Map){const s=t.get(n);if(s)return s;const{val:i,meta:{tag:r,op:o,ops:a,usedCats:h}}=n,p=r&&ze(r,(k,D)=>h.has(D)),d=pe(i,ve(lt(r))),u=new Set;function S(k,D){return k.map((z,U)=>{const v=Be(z,t);return v.name?(u.add(v),v.name):(v.deps.forEach(q=>u.add(q)),v.prec>=D?v.formula:l("span",{children:["(",v.formula,")"]},U))})}let g,x=1/0;switch(o){case"const":g=d,x=1/0;break;case"sum":case"prod":case"max":case"min":{const{head:k,joiner:D,end:z}=re[o];x=re[o].prec,g=l("span",{children:[k,S(a,x).map((U,v)=>l(c.Fragment,{children:[U,v<a.length-1&&D]},v)),z]})}break;case"sumfrac":{const[k]=S(a,2),[D,z]=S(a,1);g=l("span",{children:[k," / (",D," + ",z,")"]}),x=re.prod.prec;break}case"floor":g=`⌊${a[0].val}⌋`,x=1/0;break;default:Fe(o)}let m,C;p&&(m=l("span",{children:[e(Me,{tag:p})," ",d]}),C=void 0);const R={name:m,formula:g,prec:x,sheet:C,deps:[...new Set(u)]};return t.set(n,R),R}const re={sum:{head:"",joiner:" + ",end:"",prec:1},prod:{head:"",joiner:" * ",end:"",prec:2},max:{head:"Max(",joiner:", ",end:")",prec:1/0},min:{head:"Min(",joiner:", ",end:")",prec:1/0}};function Zt({character:n,charOpt:t,children:s}){const i=Yt(n),r=c.useMemo(()=>Ne([...He([n.key]),...i,X.common.lvl.add(80),X.common.res.add(.1),X.common.isBroken.add(0),X.common.maxToughness.add(100),We.common.critMode.add("avg"),...t.conditionals.flatMap(({sheet:o,src:a,dst:h,condKey:p,condValue:d})=>xe("preset0",Ge(o,a,h)(p,d))),...t.bonusStats.flatMap(({tag:o,value:a})=>xe("preset0",{tag:{...o},value:Qe(a)}))]),[n.key,i,t.conditionals,t.bonusStats]);return e(Kt.Provider,{value:r,children:s})}function Yt(n){const t=Wt(n==null?void 0:n.equippedLightCone),s=Ue(n==null?void 0:n.equippedRelics),i=c.useMemo(()=>{const o=t;return o?$e(o.key,o.level,o.ascension,o.superimpose):[]},[t]),r=c.useMemo(()=>s?ct(Object.values(s).filter(Ve)):[],[s]);return c.useMemo(()=>n?Xe(n.key,...Je(n,1),...i,...r):[],[n,i,r])}function en(){const{database:n}=L(),{key:t}=P(),{bonusStats:s}=G(t),i=c.useCallback((o,a,h)=>n.charOpts.setBonusStat(t,o,a,h),[n,t]),r=o=>{const a=tn(o,t);n.charOpts.setBonusStat(t,a,0)};return l(b,{children:[e(W,{title:"Bonus Stats"}),e(O,{}),e(w,{children:l(E,{spacing:1,children:[s.map(({tag:o,value:a},h)=>e(on,{tag:o,value:a,setValue:p=>i(o,p),onDelete:()=>i(o,null),setTag:p=>i(p,0)},JSON.stringify(o)+h)),e(sn,{onSelect:r})]})})]})}function tn(n,t){return{src:t,dst:t,et:"own",q:n,qt:"premod",sheet:"agg"}}const nn=["hp","hp_","def","def_","atk","atk_","spd","spd_","dmg_","enerRegen_","brEffect_","crit_","crit_dmg_","eff_","eff_res_","heal_"];function sn({tag:n={},onSelect:t}){var s;return e(H,{title:(n&&((s=ht.subset(n)[0])==null?void 0:s.title))??"Add Bonus Stat",children:nn.map(i=>e(M,{onClick:()=>t(i),children:i},i))})}function on({tag:n,setTag:t,value:s,setValue:i,onDelete:r}){var a;const o=(a=n.name||n.q)==null?void 0:a.endsWith("_");return e(b,{bgt:"light",children:l(w,{sx:{display:"flex",gap:1,justifyContent:"space-around"},children:[e(ge,{sx:{m:"auto"},children:n.q}),n.q==="dmg_"&&e(rn,{tag:n,setElementalType:h=>{const{elementalType:p,...d}=n;t(h?{...d,elementalType:h}:d)}}),e(dt,{float:!0,value:s,sx:{flexBasis:150,flexGrow:1,height:"100%"},onChange:i,placeholder:"Stat Value",size:"small",inputProps:{sx:{textAlign:"right"}},InputProps:{endAdornment:l(ut,{position:"end",sx:{ml:0},children:[o?"%":void 0," ",e(ne,{"aria-label":"Delete Bonus Stat",onClick:r,edge:"end",children:e(Ut,{fontSize:"small"})})]})}})]})})}function rn({tag:n,setElementalType:t}){return l(H,{title:n.elementalType??"No Element",children:[e(M,{onClick:()=>t(null),children:"No Element"}),Ze.map(s=>e(M,{onClick:()=>t(s),children:s},s))]})}function an(){const n=me();return e(b,{children:e(w,{children:n==null?void 0:n.listFormulas(le.listing.formulas).map((t,s)=>e(ln,{read:t},s))})})}function ln({read:n}){const t=me();if(!t)return null;const s=t.compute(n),i=n.tag.name||n.tag.q,r=Be(s);return l(f,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e(f,{sx:{flexGrow:1},children:e(Me,{tag:n.tag})}),pe(s.val,ve(i??"")),e(Ye,{title:l(T,{component:"div",children:[e(f,{children:r.name}),e(O,{}),e(f,{children:r.formula}),e(E,{spacing:1,sx:{pl:1,pt:1},children:r.deps.map((o,a)=>l(f,{children:[e(f,{children:o.name}),e(O,{}),l(f,{children:[" ",o.formula]})]},a))})]}),children:e(pt,{})})]})}function cn(){const{key:n}=P(),{conditionals:t}=G(n),[s,i]=c.useState(""),r=c.useMemo(()=>{const o=t.map(a=>a.sheet).filter(et);return s&&o.push(s),[...new Set(o)].sort(a=>a===s?-1:1)},[t,s]);return l(E,{spacing:1,sx:{pt:1},children:[e(Gt,{lcKey:s,setLCKey:i,label:"Search Light Cone"}),e(f,{children:e(j,{container:!0,columns:3,spacing:1,children:r.map(o=>e(j,{item:!0,xs:1,children:e(gt,{lcKey:o})},o))})})]})}function dn(n){const{database:t}=L();return Le(t.generatedBuildList,n)}const un=c.memo(function(){const{optConfig:t}=c.useContext(A),s=dn(t.generatedBuildListId??"");return e(E,{spacing:1,children:s==null?void 0:s.builds.map((i,r)=>e(b,{children:l(w,{children:[l(f,{sx:{display:"flex",justifyContent:"space-between",gap:1},children:[l(T,{children:["Build ",r+1,": ",pe(i.value)]}),e(hn,{build:i})]}),e(Te,{relicIds:i.relicIds,lightConeId:i.lightConeId})]})},`${r}-${i.lightConeId}-${Object.values(i.relicIds).join("-")}`))})});function hn({build:{relicIds:n,lightConeId:t}}){const{t:s}=N("build"),{database:i}=L(),{key:r}=P(),o=c.useCallback(()=>{Object.entries(n).forEach(([a,h])=>i.chars.setEquippedRelic(r,a,h)),i.chars.setEquippedLightCone(r,t)},[r,i.chars,t,n]);return e(y,{color:"info",size:"small",startIcon:e(ft,{}),onClick:o,children:s("buildDisplay.equipToCrr")})}const pn=c.memo(function({disabled:t=!1}){const{database:s}=L(),{optConfigId:i,optConfig:r}=c.useContext(A);return l(b,{bgt:"light",children:[e(w,{sx:{display:"flex",gap:1},children:e(T,{sx:{fontWeight:"bold"},children:"LightCone Level Filter"})}),e(O,{}),e(Jt,{levelLow:(r==null?void 0:r.lcLevelLow)??Y,levelHigh:(r==null?void 0:r.lcLevelHigh)??Y,setLow:o=>s.optConfigs.set(i,{lcLevelLow:o}),setHigh:o=>s.optConfigs.set(i,{lcLevelHigh:o}),setBoth:(o,a)=>s.optConfigs.set(i,{lcLevelLow:o,lcLevelHigh:a}),disabled:t})]})});function gn({numLightCone:n,disabled:t}){const{database:s}=L(),{optConfigId:i,optConfig:r}=c.useContext(A),[o,a,h]=Ce();return e(b,{bgt:"light",children:e(w,{children:l(E,{spacing:1,children:[l($,{sx:{display:"flex",gap:2,justifyContent:"space-between",alignItems:"center"},children:[l($,{sx:{display:"flex",gap:1,justifyContent:"space-between"},children:["LightCones:"," ",e(ge,{color:n?"primary":"error",children:n})]}),e(y,{sx:{flexGrow:1},startIcon:r.optLightCone?e(jt,{}):e(zt,{}),color:r.optLightCone?"success":"secondary",onClick:()=>s.optConfigs.set(i,{optLightCone:!r.optLightCone}),children:"Optimize LightCone"})]}),e(fn,{show:o,onClose:h}),e(y,{color:"info",fullWidth:!0,onClick:a,disabled:t||!r.optLightCone,children:"LightCone Filter Config"})]})})})}function fn({show:n,onClose:t,disabled:s}){const{database:i}=L(),{optConfigId:r,optConfig:o}=c.useContext(A);return e(fe,{open:n,onClose:t,children:l(b,{children:[e(W,{title:"LightCone Filter",action:e(ne,{onClick:t,children:e(se,{})})}),e(O,{}),e(w,{children:e(c.Suspense,{fallback:e(ke,{width:"100%",height:"500px"}),children:l(E,{spacing:1,children:[e(pn,{disabled:s}),e(mn,{disabled:s}),e(y,{disabled:s,onClick:()=>i.optConfigs.set(r,{useEquippedLightCone:!o.useEquippedLightCone}),color:o.useEquippedLightCone?"success":"secondary",children:"Use equipped LightCone"})]})})})]})})}function mn({disabled:n}){const{database:t}=L(),{optConfigId:s,optConfig:i}=c.useContext(A),{lightConePaths:r}=i,o=ue(t.lightCones),{key:a}=P(),h=c.useMemo(()=>o&&i.optLightCone?t.lightCones.values.reduce((p,{key:d,level:u,location:S})=>{if(u<i.lcLevelLow||u>i.lcLevelHigh||S&&!i.useEquippedLightCone&&S!==a)return p;const g=Oe(d).path;return g&&p[g]++,p},te(ye,()=>0)):te(ye,()=>0),[a,o,t.lightCones,i.lcLevelLow,i.lcLevelHigh,i.optLightCone,i.useEquippedLightCone]);return e(Ot,{onChange:p=>t.optConfigs.set(s,{lightConePaths:p}),value:r,disabled:n,totals:h,fullWidth:!0})}const Cn=c.memo(function({disabled:t=!1}){const{database:s}=L(),{optConfigId:i,optConfig:r}=c.useContext(A);return l(b,{bgt:"light",children:[e(w,{sx:{display:"flex",gap:1},children:e(T,{sx:{fontWeight:"bold"},children:"Relic Level Filter"})}),e(O,{}),e(Qt,{levelLow:(r==null?void 0:r.levelLow)??ee[5],levelHigh:(r==null?void 0:r.levelHigh)??ee[5],setLow:o=>s.optConfigs.set(i,{levelLow:o}),setHigh:o=>s.optConfigs.set(i,{levelHigh:o}),setBoth:(o,a)=>s.optConfigs.set(i,{levelLow:o,levelHigh:a}),disabled:t})]})});function xn({disabled:n=!1,setFilter4Cavern:t,setFilter2Cavern:s,setFilter2Planar:i,setSetFilter4Cavern:r,setSetFilter2Cavern:o,setSetFilter2Planar:a}){const[h,p,d]=Ce();return l(b,{bgt:"light",children:[e(fe,{open:h,onClose:d,children:e(yn,{onClose:d,setFilter2Cavern:s,setFilter4Cavern:t,setFilter2Planar:i,setSetFilter2Cavern:o,setSetFilter4Cavern:r,setSetFilter2Planar:a})}),l(w,{sx:{display:"flex",gap:1},children:[l(f,{sx:{flexGrow:1,display:"flex",gap:1,flexDirection:"column"},children:[t.length<=1?l(H,{disabled:n,title:t[0]?l("span",{children:["Force 4-Set:"," ",e("strong",{children:e(_,{setKey:t[0]})})]}):"Select to force 4-Set",sx:{flexGrow:1},children:[e(M,{onClick:()=>r([]),children:"No 4-Set"}),ce.map(u=>e(M,{onClick:()=>r([u]),children:e(_,{setKey:u})},u))]}):e(y,{disabled:!0,children:l("span",{children:[e("strong",{children:t.length})," Relic 4p-set Selected"]})}),s.length<=1?l(H,{disabled:n,title:s[0]?l("span",{children:["Force 2-Set:"," ",e("strong",{children:e(_,{setKey:s[0]})})]}):"Select to force 2-Set",sx:{flexGrow:1},children:[e(M,{onClick:()=>o([]),children:"No 2-Set"}),ce.map(u=>e(M,{onClick:()=>o([u]),children:e(_,{setKey:u})},u))]}):e(y,{disabled:!0,children:l("span",{children:[e("strong",{children:s.length})," Relic Cavern 2p-set Selected"]})}),i.length<=1?l(H,{disabled:n,title:i[0]?l("span",{children:["Force 2-Set:"," ",e("strong",{children:e(_,{setKey:i[0]})})]}):"Select to force 2-Set",sx:{flexGrow:1},children:[e(M,{onClick:()=>a([]),children:"No 2-Set"}),we.map(u=>e(M,{onClick:()=>a([u]),children:e(_,{setKey:u})},u))]}):e(y,{disabled:!0,children:l("span",{children:[e("strong",{children:i.length})," Relic Planar 2p-set Selected"]})})]}),e(f,{sx:{display:"flex",alignItems:"stretch"},children:e(y,{disabled:n,onClick:p,color:"info",children:"Advanced Set-Filter Config"})})]})]})}function yn({onClose:n,setFilter4Cavern:t,setFilter2Cavern:s,setFilter2Planar:i,setSetFilter4Cavern:r,setSetFilter2Cavern:o,setSetFilter2Planar:a}){return l(b,{children:[e(W,{title:"Advanced Set-Filter Config",action:e(ne,{onClick:n,children:e(se,{})})}),e(O,{}),l(w,{children:[e(T,{variant:"h6",children:"Cavern"}),l(f,{sx:{display:"flex",gap:1,mb:1},children:[e(y,{disabled:!t.length,onClick:()=>r([]),children:"Reset 4p filter"}),e(y,{disabled:!s.length,onClick:()=>o([]),children:"Reset 2p filter"})]}),e(j,{container:!0,spacing:1,children:ce.map(h=>e(j,{item:!0,xs:1,md:2,lg:3,children:e(bn,{setKey:h,setFilter4Cavern:t,setFilter2Cavern:s,setSetFilter4Cavern:r,setSetFilter2Cavern:o})},h))}),e(T,{variant:"h6",children:"Planar"}),e(f,{sx:{display:"flex",gap:1,mb:1},children:e(y,{disabled:!s.length,onClick:()=>a([]),children:"Reset 2p filter"})}),e(j,{container:!0,spacing:1,children:we.map(h=>e(j,{item:!0,xs:1,md:2,lg:3,children:e(Sn,{setKey:h,setFilter2Planar:i,setSetFilter2Planar:a})},h))})]})]})}function bn({setKey:n,setFilter4Cavern:t,setFilter2Cavern:s,setSetFilter4Cavern:i,setSetFilter2Cavern:r}){return l(b,{bgt:"light",children:[e(W,{title:e(_,{setKey:n}),avatar:e(Ie,{src:Ke(n,Re(n)),size:2})}),l(De,{fullWidth:!0,children:[e(y,{color:!t.length||t.includes(n)?"success":"secondary",onClick:()=>i(t.length?de([...t],n):[n]),children:"Allow 4p"}),e(y,{color:!s.length||s.includes(n)?"success":"secondary",onClick:()=>r(s.length?de([...s],n):[n]),children:"Allow 2p"})]})]})}function Sn({setKey:n,setFilter2Planar:t,setSetFilter2Planar:s}){return l(b,{bgt:"light",children:[e(W,{title:e(_,{setKey:n}),avatar:e(Ie,{src:Ke(n,Re(n)),size:2})}),e(De,{fullWidth:!0,children:e(y,{color:!t.length||t.includes(n)?"success":"secondary",onClick:()=>s(t.length?de([...t],n):[n]),children:"Allow 2p"})})]})}function Ln({relicsBySlot:n}){const[t,s,i]=Ce();return e(b,{bgt:"light",children:e(w,{children:l(E,{spacing:1,children:[e($,{sx:{display:"flex",gap:2,justifyContent:"space-between"},children:Ee.map(r=>e(F,{relicsBySlot:n,slotKey:r},r))}),e(vn,{show:t,onClose:i,relicsBySlot:n}),e(y,{color:"info",fullWidth:!0,onClick:s,children:"Relic Filter Config"})]})})})}function F({relicsBySlot:n,slotKey:t}){return l(T,{children:["Relic ",t," ",e(ge,{color:n[t].length?"primary":"error",children:n[t].length})]})}function vn({relicsBySlot:n,show:t,onClose:s,disabled:i}){const{database:r}=L(),{optConfigId:o,optConfig:a}=c.useContext(A);return e(fe,{open:t,onClose:s,children:l(b,{children:[e(W,{title:"Relic Filter",action:e(ne,{onClick:s,children:e(se,{})})}),e(O,{}),e(w,{children:e(c.Suspense,{fallback:e(ke,{width:"100%",height:"500px"}),children:l(E,{spacing:1,children:[e(Cn,{disabled:i}),e(kn,{relicsBySlot:n,disabled:i}),e(wn,{disabled:i}),e(y,{disabled:i,onClick:()=>r.optConfigs.set(o,{useEquipped:!a.useEquipped}),color:a.useEquipped?"success":"secondary",children:"Use equipped Relics"})]})})})]})})}function kn({relicsBySlot:n,disabled:t}){const{database:s}=L(),{optConfigId:i,optConfig:r}=c.useContext(A),o=a=>{const h=tt([...be[a]]),p={body:r.slotBodyKeys??[],feet:r.slotFeetKeys??[],sphere:r.slotSphereKeys??[],rope:r.slotRopeKeys??[]},d={body:u=>s.optConfigs.set(i,{slotBodyKeys:u}),feet:u=>s.optConfigs.set(i,{slotFeetKeys:u}),sphere:u=>s.optConfigs.set(i,{slotSphereKeys:u}),rope:u=>s.optConfigs.set(i,{slotRopeKeys:u})};return e($,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:be[a].map(u=>e(y,{disabled:t,variant:p[a].includes(u)?"contained":"outlined",onClick:()=>d[a](h([...p[a]],u)),children:e(Pt,{statKey:u,showPercent:!0})},u))})};return e(b,{bgt:"light",children:e(w,{children:l(E,{spacing:1,children:[l($,{sx:{display:"flex",justifyContent:"space-between"},children:[e(F,{slotKey:"head",relicsBySlot:n}),e(F,{slotKey:"hands",relicsBySlot:n})]}),e(F,{slotKey:"body",relicsBySlot:n}),o("body"),e(F,{slotKey:"feet",relicsBySlot:n}),o("feet"),e(F,{slotKey:"sphere",relicsBySlot:n}),o("sphere"),e(F,{slotKey:"rope",relicsBySlot:n}),o("rope")]})})})}function wn({disabled:n}){const{database:t}=L(),{optConfigId:s,optConfig:i}=c.useContext(A),{setFilter4Cavern:r,setFilter2Cavern:o,setFilter2Planar:a}=i,h=c.useCallback(u=>{t.optConfigs.set(s,{setFilter2Cavern:u})},[t,s]),p=c.useCallback(u=>{t.optConfigs.set(s,{setFilter4Cavern:u})},[t,s]),d=c.useCallback(u=>{t.optConfigs.set(s,{setFilter2Planar:u})},[t,s]);return e(xn,{disabled:n,setFilter2Cavern:o,setFilter4Cavern:r,setFilter2Planar:a,setSetFilter2Cavern:h,setSetFilter4Cavern:p,setSetFilter2Planar:d})}function In(){const{key:n}=P(),{optConfigId:t}=G(n),{database:s}=L();return c.useEffect(()=>{if(t)return;const i=s.optConfigs.new();s.charOpts.set(n,{optConfigId:i})},[s,t,n]),t?l(nt,{optConfigId:t,children:[e(Rn,{}),e(un,{})]}):null}function Rn(){const{t:n}=N("optimize"),{database:t}=L(),s=me(),{key:i}=P(),{target:r}=G(i),[o,a]=c.useState(8),[h,p]=c.useState(void 0),{optConfig:d,optConfigId:u}=c.useContext(A),S=ue(t.relics),g=c.useMemo(()=>{const v={body:d.slotBodyKeys,feet:d.slotFeetKeys,sphere:d.slotSphereKeys,rope:d.slotRopeKeys},q=I=>["body","feet","sphere","rope"].includes(I);return S&&t.relics.values.reduce((I,B)=>{const{slotKey:K,mainStatKey:ie,level:oe,location:V}=B;return oe<d.levelLow||oe>d.levelHigh||V&&!d.useEquipped&&V!==i||q(K)&&!v[K].includes(ie)||I[B.slotKey].push(B),I},{head:[],hands:[],feet:[],body:[],sphere:[],rope:[]})},[i,t.relics,d.levelHigh,d.levelLow,d.slotBodyKeys,d.slotFeetKeys,d.slotRopeKeys,d.slotSphereKeys,d.useEquipped,S]),x=ue(t.lightCones),m=c.useMemo(()=>x&&t.lightCones.values.filter(({key:v,level:q,location:I})=>{if(!d.optLightCone)return I===i;if(q<d.lcLevelLow||q>d.lcLevelHigh||I&&!d.useEquippedLightCone&&I!==i)return!1;const{path:B}=Oe(v);return!!d.lightConePaths.includes(B)}),[i,t.lightCones,d.lcLevelLow,d.lcLevelHigh,d.optLightCone,d.lightConePaths,d.useEquippedLightCone,x]),C=c.useMemo(()=>mt(Object.values(g))*m.length,[m.length,g]),[R,k]=c.useState(!1),D=c.useRef(()=>{});c.useEffect(()=>()=>D.current(),[]);const z=c.useCallback(async()=>{if(!s)return;const v=new Promise(K=>D.current=K);p(void 0),k(!0);const q=(d.statFilters??[]).filter(K=>!K.disabled),I=Ct(i,s,[{tag:r,multiplier:1}],d.maxBuildsToShow,q,d.setFilter2Cavern,d.setFilter4Cavern,d.setFilter2Planar,m,g,o,p);v.then(()=>I.terminate("user cancelled"));let B;try{B=await I.results}catch{return}finally{D.current=()=>{},k(!1)}B.length&&t.optConfigs.newOrSetGeneratedBuildList(u,{builds:B.map(({ids:K,value:ie})=>({lightConeId:K[0],relicIds:te(Ee,(oe,V)=>K[V+1]),value:ie})),buildDate:Date.now()})},[s,d.statFilters,d.maxBuildsToShow,d.setFilter2Cavern,d.setFilter4Cavern,d.setFilter2Planar,i,r,m,g,o,t.optConfigs,u]),U=c.useCallback(()=>{D.current(),k(!1)},[D]);return e(b,{children:e(w,{children:l(E,{spacing:1,children:[e(xt,{}),e(gn,{numLightCone:m.length}),e(Ln,{relicsBySlot:g}),h&&e(Dn,{progress:h,total:C}),l(f,{sx:{display:"flex",justifyContent:"space-between"},children:[e(Xt,{maxBuildsToShow:d.maxBuildsToShow,optConfigId:u}),e(yt,{numWorkers:o,setNumWorkers:a}),e(y,{disabled:!C,onClick:R?U:z,color:R?"error":"primary",startIcon:R?e(se,{}):e(bt,{}),children:n(R?"cancel":"optimize")})]})]})})})}function J({value:n}){const t=n.toLocaleString();return e(f,{sx:{fontFamily:"Monospace",display:"inline"},children:t})}function Dn(n){const{t}=N("optimize"),{computed:s,remaining:i,skipped:r}=n.progress,o=s+i,a=Math.log1p(o)/Math.log1p(n.total),h=i/o*a;return l(f,{children:[l(T,{children:[t("computed"),": ",e(J,{value:s})," /"," ",e(J,{value:o})," "]}),l(T,{children:[t("computed + skipped"),": ",e(J,{value:s+r})," /"," ",e(J,{value:n.total})]}),e(St,{variant:"determinate",value:(1-h)*100,sx:{height:10,borderRadius:5}})]})}function En(){const{key:n}=P(),{conditionals:t}=G(n),[s,i]=c.useState(""),r=c.useMemo(()=>{const o=t.map(a=>a.sheet).filter(st);return s&&o.push(s),[...new Set(o)].sort(a=>a===s?-1:1)},[t,s]);return l(E,{spacing:1,sx:{pt:1},children:[e($t,{relicSetKey:s,setRelicSetKey:i,label:"Search Relic Set"}),e(f,{children:e(j,{container:!0,columns:3,spacing:1,children:r.map(o=>e(j,{item:!0,xs:1,children:e(Lt,{setKey:o})},o))})})]})}const Mn=210,Pe=c.createContext(Mn),Tn=0,ae=33,qe=c.createContext(0);function Kn(){const n=c.useMemo(()=>[["char","Character",e(An,{},"char")],["relicCond","Relic Conditionals",e(En,{},"relicCond")],["lightConeCond","Light Cone Conditionals",e(cn,{},"lightConeCond")],["opt","Optimize",e(Bn,{},"opt")]],[]);return e(qe.Provider,{value:n.length,children:e(E,{gap:1,children:n.map(([t,s,i],r)=>e(On,{title:s,index:r,children:i},t))})})}function On({index:n,title:t,children:s}){const[i,r]=kt(),o=c.useContext(qe),a=c.useContext(Pe);return l(he,{children:[e(b,{sx:h=>({outline:`solid ${h.palette.secondary.main}`,position:"sticky",top:a+n*ae,bottom:Tn+(o-1-n)*ae,zIndex:100}),children:e(Vt,{onClick:r,sx:{px:1},children:e(T,{variant:"h6",children:t})})}),e(f,{ref:i,sx:{scrollMarginTop:a+(n+1)*ae},children:s})]})}function An(){const n=P(),{key:t}=n,[s,i]=c.useState(void 0);return l(E,{spacing:1,children:[l(f,{sx:{display:"flex",gap:1},children:[l(f,{sx:{minWidth:"350px"},children:[e(Ft,{character:n,hideStats:!0}),e(Nt,{characterKey:s,onClose:()=>i(void 0)}),e(y,{fullWidth:!0,disabled:!t,onClick:()=>t&&i(t),children:"Edit Character"}),e(an,{})]}),e(Pn,{})]}),e(en,{}),e(vt,{formulasRead:le.listing.formulas,buffsRead:le.listing.buffs})]})}function Bn(){return e(In,{})}function Pn(){const{equippedRelics:n,equippedLightCone:t}=P();return e(b,{sx:{width:"100%"},children:e(w,{children:e(Te,{relicIds:n,lightConeId:t})})})}function qn({character:{key:n},charOpt:{target:t}}){const{database:s}=L();return e(wt,{optTarget:t,setOptTarget:i=>s.charOpts.set(n,{target:i}),buttonProps:{fullWidth:!0,sx:{height:"100%"}}})}function Qn(){const{database:n}=L(),[t,s]=c.useState(it[0]),{t:i}=N(["charNames_gen","page_character"]),r=Ht(t);c.useEffect(()=>{t&&!r&&n.chars.getOrCreate(t)},[t,r,n.chars]);const o=G(t);c.useEffect(()=>{t&&!o&&n.charOpts.getOrCreate(t)},[t,o,n.charOpts]),It(c.useMemo(()=>`Optimize - ${i(t?"charNames_gen:Character":"Optimize")}`,[t,i]));const a=c.useMemo(()=>{const x=te(t?[t]:[],m=>e(_t,{genderedKey:qt(m)}));return{srcDisplay:x,dstDisplay:x}},[t]),h=c.useCallback((g,x,m,C,R)=>{!ot(g)||!Se(m)||!(C===null||Se(C))||!rt(g,x)||n.charOpts.setConditional(t,g,x,m,C,R)},[t,n.charOpts]),p=c.useMemo(()=>({src:t,dst:t,preset:"preset0"}),[t]),[d,u]=c.useState(),S=c.useMemo(()=>({read:d,setRead:u}),[d]);return l(f,{children:[e(Rt,{charKey:t,setCharKey:g=>g&&s(g)}),r&&o&&e(at.Provider,{value:r,children:e(At.Provider,{value:p,children:e(Zt,{character:r,charOpt:o,children:e(Dt.Provider,{value:a,children:e(Et.Provider,{value:o.conditionals,children:e(Mt.Provider,{value:h,children:l(Bt.Provider,{value:S,children:[e(Tt,{}),l(f,{sx:{display:"flex",gap:1,flexDirection:"column",mt:2},children:[e(qn,{character:r,charOpt:o}),e(Pe.Provider,{value:0,children:e(Kn,{})})]})]})})})})})})})]})}export{Qn as default};
